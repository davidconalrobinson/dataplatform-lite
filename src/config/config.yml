---
# Database connection parameters
username: 'postgres'
password: 'postgres'
host: 'db_infra'
port: '5432'
database: 'dataplatform-lite-db'
schema: 'db'
# Database objects
objects:
  customers:
    description: This table contains one row per customer
    api:
      - post
    columns:
      id:
        dtype: 'String'
        description: 'Unique customer identifier'
        pii: False
        primary_key: True
      name:
        description: 'Name of customer'
        dtype: 'String'
        pii: True
      phone_no:
        description: 'Customer phone number'
        dtype: 'String'
        pii: True
      address:
        description: 'Address of customer'
        dtype: 'String'
        pii: True
  orders:
    description: This table contains one row per order
    api:
      - get
      - post
    columns:
      id:
        dtype: 'String'
        description: 'Unique order identifier'
        pii: False
        primary_key: True
      customer_id:
        dtype: 'String'
        description: 'Unique customer identifier'
        pii: False
      product:
        description: 'The product that has been ordered'
        dtype: 'String'
        pii: False
      quantity:
        description: 'Quantity ordered'
        dtype: 'Integer'
        pii: False
      price_per_unit:
        description: 'The per-unit price for this product'
        dtype: 'Numeric'
        pii: False
  invoices:
    description: This table contains one row per invoice
    api:
      - get
    columns:
      id:
        dtype: 'String'
        description: 'Unique invoice identifier'
        pii: False
        primary_key: True
      order_id:
        dtype: 'String'
        description: 'Unique order identifier'
        pii: False
      name:
        description: 'Name of customer'
        dtype: 'String'
        pii: True
      address:
        description: 'Address of customer'
        dtype: 'String'
        pii: True
      amount_payable:
        description: 'Amount payable'
        dtype: 'Numeric'
        pii: False
# Database trigger functions
trigger_functions:
  - |
    CREATE OR REPLACE FUNCTION db.generate_invoice()
    RETURNS TRIGGER AS
    $$
      BEGIN
        INSERT INTO db.invoices (id, order_id, name, address, amount_payable)
        SELECT
          uuid_generate_v1() AS id,
          orders.id AS order_id,
          customers.name,
          customers.address,
          orders.quantity*orders.price_per_unit AS amount_payable
        FROM (SELECT NEW.*) orders
        INNER JOIN db.customers customers
        ON orders.customer_id = customers.id
        ON CONFLICT DO NOTHING;
        RETURN NULL;
      EXCEPTION WHEN OTHERS THEN
        RETURN NULL; -- Do nothing.
      END;
    $$
    LANGUAGE PLPGSQL;
    DROP TRIGGER IF EXISTS generate_invoice ON db.orders;
    CREATE TRIGGER generate_invoice
    AFTER INSERT ON db.orders
    FOR EACH ROW EXECUTE PROCEDURE db.generate_invoice();
